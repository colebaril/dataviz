---
title: "Spotify Wrapped: R and ggplot2 Edition"
author: "Cole Baril"
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float:
      collapsed: false
    code_download: true
---

<!--- This style block is to tweak the formatting of the data tables in the report --->
<style>

  h1 {
  font-weight: bold;
}

  h2 {
  font-weight: bold;
  }

  table {
    display: block;
    overflow: auto;
  }

  blockquote {
    background-color: #1DB954;
    color: white;
    font-weight: bold;
 }

</style>

# Setup

```{r setup, include = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.8, out.width = "100%", message = FALSE, warning = FALSE)

options(max.print=1000000)
```

## Load packages

```{r message = FALSE, warning = FALSE, echo = FALSE}
require(pacman)
p_load(tidyverse, jsonlite, knitr, gghighlight, plotly, hms, lubridate, here, gt, webshot, janitor, spotidy, zoo, extrafont)


```

## Import & Clean

```{r}
streamingData <- map_df(list.files(pattern = "*.json",
                    path = here("Spotify-wrapped/Data/"),
                    full.names = TRUE),
               ~ fromJSON(., flatten = TRUE) 
               )



spotify <- streamingData %>% 
  as_tibble() %>%
  separate(col = "ts", 
           into = c("date","time"),
           sep = "T") %>% 
  separate(col = "time",
           into = "time",
           sep = "Z") 

datetime <- as.POSIXct(paste(spotify$date, spotify$time), format = "%Y-%m-%d %H:%M:%S")
spotify$datetime <- datetime

spotify <- spotify %>% 
  mutate(datetime = datetime - hours(6)) %>% # Convert time zones to CST
  mutate(date = floor_date(datetime, "day") %>% # Creating date 
           as_date, minutes = ms_played / 60000) %>% # Convert ms played to minutes played
  mutate(time = floor_date(datetime, "minutes")) # Remove seconds from time

spotify %>% 
  glimpse(24)


# Set time limits for use in plots
lims <- as.POSIXct(strptime(c("2014-10-27", "2024-11-06"), 
                   format = "%Y-%m-%d"))

spotify$date <- ymd(spotify$date)
```


# API

```{r}
my_token <- get_spotify_api_token(client_id = "3a128392fe76404295a0ccc1803b69e4", client_secret = "ec15eca6bbf74421a0496792690b2b5f")

spotify_unique <- spotify %>% 
  mutate(spotify_track_uri = gsub("spotify:track:", "", spotify_track_uri)) %>% 
  distinct(master_metadata_track_name, .keep_all = TRUE) 

# api_data <- api_data |> 
#   distinct(track_id, .keep_all = TRUE)

api_data1 <- read.csv("api_data_master.csv") |> 
  select(-1)

api_data2 <- read.csv("api_data_nov18.csv") |> 
  select(-1)

api_data_master <- api_data1 |> 
  rbind(api_data2) |> 
  distinct(track_id, .keep_all = TRUE)

combined <- spotify |> 
  mutate(spotify_track_uri = gsub("spotify:track:", "", spotify_track_uri)) |> 
  left_join(api_data_master, by = c("spotify_track_uri" = "track_id")) |> 
  filter(is.na(danceability)) |> 
  distinct(master_metadata_track_name, .keep_all = TRUE)

# Split data frame by the number of rows 

n = 1001 # 24,000 rows, and I want groups of 1,000

split_unique <- combined %>% group_by(row_number() %/% n) %>% group_map(~ .x)


api_data <- data.frame()

api_data |> 
  write.csv(here("api_data_nov18.csv"))

# Already done 10. Starting at 1 ==
for(track_uri in split_unique %>% pluck(1) %>%  .$spotify_track_uri) {
  
  tryCatch({
	
    audio_features <- get_tracks_audio_features(track_uri)

    api_data <- rbind(api_data, audio_features)
      
    print(paste0("Retrieved data for ", api_data$track_id, " successfully."))

    
    Sys.sleep(1)
    
  }, error = function(e) {
    
    cat("Error occurred:", conditionMessage(e), "\n")
    cat("Pausing for 500 seconds to reset API limit...\n")
    Sys.sleep(500)
    
  })

}

  # Only create empty on first df list

# api_data_master <- data.frame()

api_data_master <- read_csv(here("api_data_master.csv")) %>% select(-1)

api_data_master <- rbind(api_data_master, api_data) 

api_data_master %>% 
  write.csv(here("api_data_master.csv"))


api_data <- api_data %>% 
  select(-7)

spotify_unique_diff <- spotify_unique %>% 
  left_join(api_data, by = c("spotify_track_uri" = "track_id")) %>% 
  filter(if_any(liveness, is.na))
  


```

# Testing
```{r}
api_data_master %>% 
  ggplot() +
  geom_histogram(aes(x = loudness))
```
# Genre 

```{r}
spotify <- spotify %>% 
  mutate(genre = case_when(master_metadata_album_artist_name %in% c("Armin van Buuren",
                                                                    "GAIA",
                                                                    "Aly & Fila",
                                                                    "Alex M.O.R.P.H",
                                                                    "Gareth Emery",
                                                                    "Above & Beyond",
                                                                    "ReOrder",
                                                                    "Andrew Rayel",
                                                                    "Super8 & Tab",
                                                                    "Craig Connelly") ~  "Trance",
                           master_metadata_album_artist_name %in% c("Lady Gaga",
                                                                    "Halsey") ~ "Pop"))

artist_summary <- spotify %>% 
  group_by(master_metadata_album_artist_name) %>% 
  tally()
```

# Listening Patterns Over Time

## Daily 

```{r}
spotify %>% 
  filter(ms_played >= 1000) %>% 
  group_by(date)  %>%
  # group_by(date = floor_date(date, "day")) %>% # This does not work after updates. 
  summarize(songs = n()) %>% 
  arrange(date) %>% 
  ggplot(aes(x = date, y = songs)) +
  geom_col(aes(fill = songs, colour = songs)) + # Use `colour = ` here because using `fill = ` does not work with small lines.
  scale_x_date(breaks = "1 year", 
                   date_labels = "%Y",
                   expand = c(0, 0)) + # Removes white space around the plot on the x axis 
  scale_fill_gradient(high = "#0b3e34", low = "#1db954") +
  scale_colour_gradient(high = "#0b3e34", low = "#1db954") + 
  labs(x = "Date",
       y = "Number of Songs",
       colour = "Songs") +
  guides(fill = "none") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) 
```

```{r}
rect <- data.frame(xmin = as.Date("2024-01-01"), xmax = lims[2], ymin = -Inf, ymax = Inf) |> 
  mutate(xmin = as.Date(xmin),
         xmax = as.Date(xmax))

spotify %>% 
  filter(ms_played >= 1000) %>% 
  group_by(date) %>% 
  summarize(songs = n()) %>% 
  arrange(date) %>% 
  mutate(songs_rolling = rollmean(songs, 30, fill = NA)) %>%  # 30-day rolling average
  ggplot(aes(x = date, y = songs_rolling)) +
   geom_rect(data = rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="grey40",
              fill="grey70",
              alpha = 0.5,
              inherit.aes = FALSE) +
  geom_line(aes(colour = songs_rolling), size = 1.2) +
 
  scale_x_date(breaks = "1 year", date_labels = "%Y", expand = c(0, 0)) +
  scale_colour_gradient(high = "#0b3e34", low = "#1db954") + 
  labs(title = "Number of Songs Played Daily: 30-Day Rolling Average",
       x = "Date", y = "Number of Songs (30-day Rolling Average)", colour = "Songs") +
  theme_bw(base_size = 20, base_family = "Courier New") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "top",
        legend.title.position = "top",
        legend.title = element_text(hjust = 0.5),
        legend.key.width = unit(2.5, "lines"),
        legend.key.height = unit(1, "lines"),
        legend.background = element_rect(fill = "#f5f5f2"),
        plot.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")
        )



```

## Monthly

```{r}
spotify %>% 
  filter(ms_played >= 1000) %>% 
  group_by(date) %>%
  group_by(date = floor_date(date, "month")) %>% 
  summarize(songs = n()) %>% 
  arrange(date) %>% 
  ggplot(aes(x = date, y = songs)) +
  geom_col(aes(fill = songs, colour = songs)) + # Use `colour = ` here because using `fill = ` does not work with small lines.
  scale_x_date(breaks = "1 year", 
                   date_labels = "%Y",
               expand = c(0, 0)) + # Removes white space around the plot on the x axis 
  scale_fill_gradient(high = "#0b3e34", low = "#1db954") +
  scale_colour_gradient(high = "#0b3e34", low = "#1db954") + 
  labs(x = "Date",
       y = "Number of Songs",
       colour = "Songs") +
  guides(fill = "none") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) 

spotify %>%
  filter(ms_played >= 1000) %>%
  mutate(month = month(date, label = TRUE)) %>%
  mutate(year = year(date)) %>%
  group_by(year, month) %>%
  summarize(total_songs = n()) %>%
  drop_na(month) |> 
  ggplot(aes(x = month, y = total_songs, fill = total_songs)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_gradient("Total Songs", low = "#1db954", high = "#0b3e34", labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
  scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
  labs(title = "Songs Played by Month",
       x = "Month", y = "Total Songs Played") +
  theme_bw(base_size = 20, base_family = "Courier New") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "top",
        legend.title.position = "top",
        legend.title = element_text(hjust = 0.5),
        legend.key.width = unit(2.5, "lines"),
        legend.key.height = unit(1, "lines"),
        legend.background = element_rect(fill = "#f5f5f2"),
        plot.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        # panel.border = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10)
        )


```

## Listening Heat map

> This heat map shows the *total* number of minutes spent listening to Spotify during each hour in the day on each weekday. 

```{r}
spotify %>% 
  group_by(date, hour = hour(datetime), weekday = wday(date, label = TRUE)) %>% 
  summarize(minuteslistened = sum(minutes)) %>% 
  mutate(year = format(date, "%Y")) %>% 
  group_by(hour, weekday) %>% 
  summarize(minuteslistened = sum(minuteslistened)) %>% 
  drop_na() %>% # NA Weekday value of 181 dropped. 
  ggplot(aes(weekday, hour, fill = minuteslistened)) +
  geom_tile(colour = "white", size = 0.1) + 
  scale_fill_gradient(high = "#0b3e34", low = "#1db954", labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
  scale_y_continuous(trans = "reverse") +
  theme_bw(base_size = 20) +
  labs(x = "Weekday",
       y = "Hour of the Day (24-Hour, CST)",
       fill = "Minutes",
       title = "Spotify Weekly Listening Heatmap",
       subtitle = "2014 to 2024 | Total Minutes: 328, 934 (228 Days)") +
  theme_bw(base_size = 20, base_family = "Courier New") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        # legend.position = "top",
        # legend.title.position = "top",
        legend.title = element_text(hjust = 0.5),
        # legend.key.width = unit(2.5, "lines"),
        # legend.key.height = unit(1, "lines"),
        legend.background = element_rect(fill = "#f5f5f2"),
        plot.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.border = element_blank()
        )


spotify %>% 
  group_by(date, hour = hour(datetime), month = month(date, label = TRUE)) %>% 
  summarize(minuteslistened = sum(minutes)) %>% 
  mutate(year = format(date, "%Y")) %>% 
  group_by(hour, month) %>% 
  summarize(minuteslistened = sum(minuteslistened)) %>% 
  drop_na() %>% 
  ggplot(aes(month, hour, fill = minuteslistened)) +
  geom_tile(colour = "white", size = 0.1) + 
  scale_fill_gradient(high = "#0b3e34", low = "#1db954") +
  scale_y_continuous(trans = "reverse") +
  theme_bw() +
  labs(x = "Month",
       y = "Hour of the Day (24-Hour, CST)",
       fill = "Minutes",
       title = "Spotify Monthly Listening Heatmap",
       subtitle = "2014 to 2022") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())



```

# Artists 

> The data set is **Very** large, and `ggplot` cannot deal with very large data sets. Therefore, I will be extracting small subsets from the data. Additionally,  **Podcasts** are not considered a song with an artist, so these are excluded (for now). 

## Top 20 Artists - All Time

```{r}
spotify %>% 
  mutate(year = floor_date(date, "year")) %>% 
  mutate(year = format(year, "%Y")) %>% 
  group_by(master_metadata_album_artist_name) %>% 
  summarize(hours = sum(minutes) / 60) %>% 
  drop_na() %>% 
  arrange(desc(hours)) %>% 
  head(20, hours) %>% 
  gt() %>% 
  tab_header(title = "Top 20 Artists All Time") %>% 
  cols_label(
    master_metadata_album_artist_name = "Artist",
    hours = "Hours Listened") %>% 
  fmt_number(columns = hours,
             rows = everything(),
             decimals = 0) %>% 
  as_raw_html()


  

spotify %>% 
  mutate(year = floor_date(date, "year")) %>% 
  mutate(year = format(year, "%Y")) %>% 
  group_by(master_metadata_album_artist_name) %>% 
  summarize(hours = sum(minutes) / 60) %>% 
  drop_na() %>% 
  arrange(desc(hours)) %>% 
  head(50) %>% 
  gt() %>% 
  tab_header(title = "Top 20 Artists of All Time") %>% 
  cols_label(
    master_metadata_album_artist_name = "Artist",
    hours = "Hours Listened") %>% 
  fmt_number(columns = hours, decimals = 0) %>% 
  data_color(
    columns = hours,
    colors = scales::col_numeric(
      palette = c("#1db954", "#0b3e34"),
      domain = NULL
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = vars(master_metadata_album_artist_name)
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(align = "center")
    ),
    locations = cells_column_labels(everything())
  ) %>% 
  tab_source_note(
    source_note = "Data reflects listening habits from 2014 to 2022"
  ) |> as_raw_html()




```

## Listening Activity by Artist Over Time

```{r}
library(ggplot2)
library(gghighlight)
library(dplyr)
library(lubridate)

spotify %>% 
  group_by(master_metadata_album_artist_name, date = floor_date(date, "month")) %>% 
  filter(master_metadata_album_artist_name %in% c(
                                                  "Armin van Buuren", 
                                                  "Above & Beyond",
                                                  "GAIA",
                                                  "Gareth Emery",
                                                  "Alex M.O.R.P.H.",
                                                  "Gustav Mahler",
                                                  "Lady Gaga",
                                                  "ReOrder",
                                                  "Aly & Fila",
                                                  "Craig Connelly",
                                                  "Halsey",
                                                  "John Williams",
                                                  "Ilan Bluestone",
                                                  "Johann Stauss II",
                                                  "Andrew Rayel",
                                                  "Giuseppe Ottaviani",
                                                  "Super8 & Tab",
                                                  "BT",
                                                  "Cosmic Gate",
                                                  "Ian Taylor"
                                                  )) %>% 
  summarize(hours = sum(minutes) / 60) %>% 
  drop_na() %>% 
  ggplot(aes(x = date, y = hours, group = master_metadata_album_artist_name, 
             colour = master_metadata_album_artist_name)) +
  geom_line(size = 0.8) +  # Slightly thicker lines for better visibility
  scale_x_date(breaks = "1 year", date_labels = "%Y") +
  gghighlight(master_metadata_album_artist_name %in% c("Armin van Buuren", 
                                                       "Gustav Mahler", 
                                                       "Lady Gaga", 
                                                       "Halsey"),
              use_direct_label = TRUE,  # Adds direct labels on highlighted lines
              label_key = master_metadata_album_artist_name) +
  scale_color_manual(values = c("Armin van Buuren" = "#1db954", 
                                "Gustav Mahler" = "#ff7f0e", 
                                "Lady Gaga" = "#9467bd", 
                                "Halsey" = "#d62728", 
                                "Other" = "grey80")) +  # Custom color palette
  labs(title = "Hours Listened to Most Listened Artists Over Time",
       subtitle = "Top 10 artists over time, highlighting select artists",
       x = "Date", 
       y = "Hours Listened",
       colour = "Artist") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +  # Add baseline at y = 0
  theme_minimal(base_size = 15) +  # Cleaner, more modern theme
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "grey80", linetype = "dotted"),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
        legend.position = "top",  # Move legend to the top for better visibility
        legend.title = element_text(face = "bold"),
        legend.text = element_text(size = 12))

```

# Top 20 Songs

```{r}
spotify %>% 
  mutate(year = floor_date(date, "year")) %>% 
  mutate(year = format(year, "%Y")) %>% 
  group_by(master_metadata_track_name) %>% 
  summarize(hours = sum(minutes) / 60) %>% 
  drop_na() %>% 
  arrange(desc(hours)) %>% 
  head(20, hours) %>% 
  gt() %>% 
  tab_header(title = "Top 20 Songs All Time") %>% 
  cols_label(
    master_metadata_track_name = "Song",
    hours = "Hours Listened") %>% 
  fmt_number(columns = hours,
             rows = everything(),
             decimals = 0) 
```

## Most Listened to Artist in a Day

```{r}
spotify %>% 
  group_by(master_metadata_album_artist_name, 
           date = floor_date(date, "day")) %>% 
  summarize(hours = sum(minutes) / 60) %>% 
  arrange(desc(hours)) %>% 
  drop_na() %>% 
  head(100, hours) %>% 
  gt()

```

# Listening Device 

```{r}


device_time <- spotify %>% 
  mutate(device = case_when(str_detect(platform, 'Android') ~ 'Android',
                            str_detect(platform, 'iOS') ~ 'iPhone',
                            str_detect(platform, 'Windows|windows|web') ~ 'Windows',
                            str_detect(platform, 'google') ~ 'Google Home'
                            )) %>% 
  group_by(device) %>% 
  summarise_at(vars(minutes), sum) %>% 
  mutate(hours = minutes/60) %>% 
  mutate(days = hours/24)

device_time %>% 
  add_row(
    device_time %>% 
    summarise(across(2:last_col(), sum) %>% 
    mutate(device = "Total"))
    ) %>% 
  gt() %>% 
  tab_header(title = "Time Spent Listening by Platform") %>% 
  cols_label(
    device = "Platform",
    minutes = "Minutes",
    hours = "Hours",
    days = "Days") %>% 
  fmt_number(columns = c(minutes, hours, days),
             rows = everything(),
             decimals = 0) %>% 
  as_raw_html()

date_minutes <- spotify %>% 
  mutate(device = case_when(str_detect(platform, 'Android') ~ 'Android',
                            str_detect(platform, 'iOS') ~ 'iPhone',
                            str_detect(platform, 'Windows|windows|web') ~ 'Windows',
                            str_detect(platform, 'google') ~ 'Google Home'
                            )) %>% 
  group_by(device, date) %>% 
  summarise_at(vars(minutes), sum) %>% 
  mutate(hours = minutes/60) %>% 
  mutate(days = hours/24)

```

# Start-Stop 

```{r}
spotify %>%
  group_by(reason_start) %>% 
  mutate(reason_start = replace(reason_start, reason_start == "", "unknown")) %>% 
  dplyr::summarise(n = n()) %>% 
  mutate(percent = (n / sum(n))*100) %>% 
  
  gt() %>% 
    fmt_number(
      columns = everything(),
      rows = everything(),
      decimals = 0,
      sep_mark = ","
    ) %>% 
  cols_label(
    reason_start = "Reason Start",
    n = "Count",
    percent = "Percent"
  ) |> 
  as_raw_html()

spotify %>% 
  filter(reason_end == "backbtn") %>% 
  group_by(master_metadata_track_name) %>% 
  dplyr::summarise(n = n()) %>% 
  drop_na() %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  gt() %>% 
  cols_label(
    master_metadata_track_name = "Track Name",
    n = "Count"
  ) |> 
  as_raw_html()

spotify %>% 
  filter(reason_end == "backbtn") %>% 
  group_by(master_metadata_album_album_name) %>% 
  dplyr::summarise(n = n()) %>% 
  drop_na() %>% 
  arrange(desc(n))

spotify %>% 
  filter(reason_end == "backbtn") %>% 
  group_by(master_metadata_album_artist_name) %>% 
  dplyr::summarise(n = n()) %>% 
  drop_na() %>% 
  arrange(desc(n))

spotify %>% 
  mutate(reason_start = replace(reason_start, reason_start == "", "unknown")) %>% 
  ggplot(aes(x = minutes)) + 
  geom_histogram(aes(fill = reason_start), bins = 150) +
  scale_x_continuous(limits = c(0,10)) +
  scale_fill_viridis_d("Track Start")

spotify %>% 
  mutate(reason_end = replace(reason_end, reason_end == "unknown", "Unknown"),
         reason_end = replace(reason_end, reason_end == "", "Unknown"),
         reason_end = replace(reason_end, reason_end == "unexpected-exit", "Misc"),
         reason_end = replace(reason_end, reason_end == "unexpected-exit-while-paused", "Misc"),
         reason_end = replace(reason_end, reason_end == "remote", "Misc"),
         reason_end = replace(reason_end, reason_end == "trackerror", "Misc"),
         reason_end = replace(reason_end, reason_end == "logout", "Misc"),
         reason_end = replace(reason_end, reason_end == "popup", "Misc"),
         reason_end = replace(reason_end, reason_end == "appload", "App Load"),
         reason_end = replace(reason_end, reason_end == "backbtn", "Back Button"),
         reason_end = replace(reason_end, reason_end == "fwdbtn", "Forward Button"),
         reason_end = replace(reason_end, reason_end == "endplay", "Stop Button"),
         reason_end = replace(reason_end, reason_end == "trackdone", "Track Done"),
         reason_end = replace(reason_end, reason_end == "clickrow", "New Song"),
         ) %>% 
  ggplot(aes(x = minutes)) + 
  geom_histogram(aes(fill = reason_end), bins = 150) +
  scale_x_continuous(limits = c(0,10), expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_brewer("Track End \nReason", palette = "Paired")+
  theme_bw() +
  labs(x = "Minutes Played",
       y = "Track End Instances",
       title = "Reason for Spotify Track Ends - Personal Data",
       subtitle = "For songs played for 10 minutes or less",
       caption = "Viz: Cole Baril - colebaril.ca | Data: Spotify | Software: R") +
  theme(title = element_text(size = 16, face = "bold"),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1))




```
```{r}
library(ggplot2)

# Example data for infographic
# Example sum for demonstration

# Find the most listened artist
most_listened_artist <- names(which.max(table(spotify$master_metadata_album_artist_name)))

# Filter the data to get the songs by the most listened artist
artist_data <- subset(spotify, master_metadata_album_artist_name == most_listened_artist)

# Find the most listened album
most_listened_album <- names(which.max(table(spotify$master_metadata_album_album_name)))

# Filter the data to get the songs by the most listened album
album_data <- subset(spotify, master_metadata_album_album_name == most_listened_album)


# Create example data with styled labels
data <- data.frame(
  x = rep(1:3, times = 2),  # x-coordinates for a 2x3 grid (repeated for each row)
  y = rep(2:1, each = 3),    # y-coordinates for a 2x3 grid (repeated for each column)
  label = c(
    paste0(
      "<span style='color:#232723; font-size:30px;'>Total Listening Time</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", format(as.integer(sum(spotify$minutes)), big.mark = ",", scientific = FALSE), " minutes</span>",
      "<span style='color:#457e59; font-size:35px;'><br>", "(228 days)</span>"
    ),
    
    paste0(
      "<span style='color:#232723; font-size:30px;'>Days I Played Music</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", format(as.integer(length(unique(spotify$date))), big.mark = ",", scientific = FALSE)
    ),
    
    paste0(
      "<span style='color:#232723; font-size:30px;'>Total Songs Played</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", format(as.integer(nrow(spotify)), big.mark = ",", scientific = FALSE)
    ),
    
     paste0(
      "<span style='color:#232723; font-size:30px;'>Total Artists</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", 
      format(as.integer(length(unique(spotify$master_metadata_album_artist_name))), big.mark = ",", scientific = FALSE)
    ),
    
    paste0(
      "<span style='color:#232723; font-size:30px;'>Top Artist</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", 
      names(which.max(table(spotify$master_metadata_album_artist_name))), "<br>",
       "<span style='color:#457e59; font-size:35px;'>", 
      format(as.integer(nrow(artist_data)), big.mark = ",", scientific = FALSE), " songs", "<br>",
      format(as.integer(sum(artist_data$minutes)), big.mark = ",", scientific = FALSE), " minutes"
    ),
    
     paste0(
      "<span style='color:#232723; font-size:30px;'>Top Album</span><br><br>",
      "<span style='color:#457e59; font-size:40px;'>", 
      names(which.max(table(spotify$master_metadata_album_album_name))), "<br>",
       "<span style='color:#457e59; font-size:35px;'>", 
      format(as.integer(nrow(album_data)), big.mark = ",", scientific = FALSE), " songs", "<br>",
      format(as.integer(sum(album_data$minutes)), big.mark = ",", scientific = FALSE), " minutes"
      )
  )
)
# Plot the grid of boxes with styled labels
ggplot(data) +
  geom_rect(aes(xmin = x - 0.4, xmax = x + 0.4, ymin = y - 0.4, ymax = y + 0.4),
            fill = "#62d089", color = "black", alpha = 0.5) +
  geom_richtext(aes(x = x, y = y, label = label),
                fill = NA, label.color = NA,  # Transparent background
                size = 5, lineheight = 1.3, hjust = 0.5,
                family = "Courier New", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0.5, 3.5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0.5, 2.5)) +
  theme_void(base_family = "Courier New", base_size = 20) +
  labs(title = "Spotify Wrapped: R & ggplot2 Edition",
       subtitle = "2014 to 2024: 10 years of listening habits") +
  theme(
    plot.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) 
  
  
  





  
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "top",
        legend.title.position = "top",
        legend.title = element_text(hjust = 0.5),
        legend.key.width = unit(2.5, "lines"),
        legend.key.height = unit(1, "lines"),
        legend.background = element_rect(fill = "#f5f5f2"),
        plot.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.background = element_rect(fill = "#f5f5f2", color = "#f5f5f2"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")
```

# References

```{r}
c("tidyverse", "jsonlite", "knitr", "gghighlight",
  "hms", "lubridate", "here", "gt", "webshot", "janitor", "spotidy", "zoo", "extrafont", "ggtext") %>%
  map(citation) %>%
  print(style = "text")
```

